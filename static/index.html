<!doctype html>
<html>
<head>
    <script src='/static/js/swagger-client.js' type='text/javascript'></script>
    <script src='/static/js/knockout.js'></script>
    <script>
     let specUrl = '/v1';

     class CreateRequestViewModel {
         constructor() {
             this.priority = 100;
             this.title = '';
             this.description = '';
             this.client = {};
             this.productarea = {};
         }

         forApi() {
             return {
                priority: this.priority,
                title: this.title,
                description: this.description,
                client_id: this.client.id,
                productarea_id: this.productarea.id,
             };
         }
     }

     class ViewModel {
         constructor(swaggerApi) {
             this._api = swaggerApi;
             this.newRequest = ko.observable(new CreateRequestViewModel());
         }

         async fetch() {
             let response;
             response = await this._api.get_v1_featurerequest();
             if (response.ok) {
                 this.featureRequests = ko.observable(response.obj.featurerequests);
             } else {
                 throw new Exception(response);
             }

             response = await this._api.get_v1_client();
             if (response.ok) {
                 this.clients = response.obj.clients;
             } else {
                 throw new Exception(response);
             }

             response = await this._api.get_v1_productarea();
             if (response.ok) {
                 this.productAreas = response.obj.productareas;
             } else {
                 throw new Exception(response);
             }

             return this;
         }


         async saveNewRequest() {
             let response = this._api.post_v1_featurerequest(this.newRequest().forApi());
             if (response.ok) {
                 let response = await this._api.get_v1_featurerequest();
                 if (response.ok) {
                     this.featureRequests = ko.observable(response.obj.featurerequests);
                 } else {
                     throw new Exception(response);
                 }
             } else {
                 throw new Exception(response);
             }
             this.newRequest = ko.observable(new CreateRequestViewModel());
         }

     }

     async function swaggerin () {
         const swaggerClient = await new SwaggerClient(specUrl);
         const viewModel = new ViewModel(swaggerClient.apis.default);
         ko.applyBindings(await viewModel.fetch());
     }

     swaggerin().then(() => 'swag')
    </script>
</head>
<body>
    <h1>Feature Requests</h1>
    <table>
        <thead>
            <tr><th>Priority</th><th>Title</th><th>Description</th><th>Client</th><th>Product Area</th>
        </thead>
        <tbody data-bind="foreach: featureRequests">
            <tr>
                <td><span data-bind="text: priority"></span>         </td>
                <td><span data-bind="text: title"></span>            </td>
                <td><span data-bind="text: description"></span>      </td>
                <td><span data-bind="text: client_name"></span>      </td>
                <td><span data-bind="text: productarea_name"></span> </td>
            </tr>
        </tbody>
    </table>

    <h2>Add New</h2>
    <label>Priority <input name="priority" type="number" min=1 data-bind="value: newRequest().priority"></label>
    <label>Title <input name="title" type="text" data-bind="value: newRequest().title"></label>
    <label>Description <input name="description" type="text" data-bind="value: newRequest().description"></label>
    <label>Client <select name="client" data-bind="options: clients, optionsText: 'name', value: newRequest().client, optionsCaption: 'Choose...'"></select></label>
    <label>Product Area <select name="productArea" data-bind="options: productAreas, optionsText: 'name', value: newRequest().productarea, optionsCaption: 'Choose...'" ></select></label>
    <button data-bind="click: saveNewRequest()" >Save</button>

</body>
</html>
